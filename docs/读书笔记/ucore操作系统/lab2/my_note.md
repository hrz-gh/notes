#### 笔记

**probe_memory**

```
e820map:
  memory: 0009fc00, [00000000, 0009fbff], type = 1.
  memory: 00000400, [0009fc00, 0009ffff], type = 2.
  memory: 00010000, [000f0000, 000fffff], type = 2.
  memory: 07ee0000, [00100000, 07fdffff], type = 1.
  memory: 00020000, [07fe0000, 07ffffff], type = 2.
  memory: 00040000, [fffc0000, ffffffff], type = 2.
```

**kern_entry**

和gdt与idt不同，pdt的首地址保存在cr3中，使用movl加载，而gdt与idt分别使用lgdt与lidt加载到gdtr与idtr中。页机制的启动对应cr0的bit31，段机制是bit0。

页机制启用前，操作系统运行在低虚拟地址空间，所以页机制启用后要保持低虚拟地址的对等映射，同时也要将高虚拟地址映射到低物理地址，在跳转到高虚拟地址后就可以取消对等映射了。

**page_init()**

下图为执行`page_init()`后的物理空间。共128.87M，`struct Page`一共32736个, 系统占用
443个。

```
mem_end  ---------> +---------------------------------+ 0x07fe0000
                    |         Empty Memory (*)        |
freemem_begin ----> +---------------------------------+ 0x001bb000
pages_end --------> +---------------------------------+ 0x001bad80
                    |         pages for free_mem      | 
freepages_begin --> +---------------------------------+ 0x0011d29c
                    |          pages for kern         +
pages_begin ------> +---------------------------------+ 0x0011b000  
end --------------> +---------------------------------+ 0x0011af28
                    |            ucore bss            | 
edata ------------> +---------------------------------+ 0x0011a000
                    |            ucore data           |
etext ------------> +---------------------------------+ 0x00105a94
                    |                                 |
entry-------------> +---                          ----+ 0x00100036
                    |            ucore text           |
                    |                                 |
                    |                                 |
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

**boot_map_segment(boot_pgdir, KERNBASE, KMEMSIZE, 0, PTE_W)**

当kern虚拟地址扩展到最大时，pdt中`0xc00>>2`=768到`0xf7f>>2`=991项被填充。由于多个虚拟地址可以对应一个物理地址，选取第`(VPT=0xfac<<20)>>22`=1003项表示pdt另一个虚拟地址，即为vpd=`{VPT>>22, VPT>>12, 12{1b'0}}`，这是一种自映射，把pdt本身映射为一个pt与一个物理页。同理页目录表中第i个页表的虚拟地址就为vpt_i=`{VPT>>22, (10-i的位数){1b'0}, {i}, 12{1b'0}}`。

最后虚拟地址空间为下图。

```
4G ---------------> +---------------------------------+
                    |                                 |
                    |         Empty Memory (*)        |
                    |                                 |
                    +---------------------------------+ 0xFB000000
                    |   Cur. Page Table (Kern, RW)    | RW/-- PTSIZE
VPT --------------> +---------------------------------+ 0xFAC00000
                    |        Invalid Memory (*)       | --/--
KERNTOP ----------> +---------------------------------+ 0xF8000000
                    |                                 |
                    |    Remapped Physical Memory     | RW/-- KMEMSIZE
                    |                                 |
KERNBASE ---------> +---------------------------------+ 0xC0000000
                    |                                 |
                    |                                 |
                    |                                 |
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

**boot_map_segment()**

空闲空间开始于0x001bb000处，在0~4M空间内，所以`boot_map_segment()`扩展映射空间时，可
以使用其虚拟地址来初始化页表，下图为执行`boot_map_segment()`后的物理空间，共KMEMSIZE / 4M
 = 224个页表，占用224 * 4K = 0xe0000的物理空间，0x0029b000也在0~4M空间内。

```
mem_end  ---------> +---------------------------------+ 0x07fe0000
                    |         Empty Memory (*)        |
page_table_end ---> +---------------------------------+ 0x0029b000
                    |           page table            |
page_table_begin -> +---------------------------------+ 0x001bb000
```


**gdt_init()**

分段，kern的内核栈为0-2k的虚拟地址。

ltr是将gdt中tss描述符索引值加载到tr中。


**print_pgdir()**

```
-------------------- BEGIN --------------------
PDE(0e0) c0000000-f8000000 38000000 urw
  |-- PTE(38000) c0000000-f8000000 38000000 -rw
PDE(001) fac00000-fb000000 00400000 -rw
  |-- PTE(000e0) faf00000-fafe0000 000e0000 urw
  |-- PTE(00001) fafeb000-fafec000 00001000 -rw
--------------------- END ---------------------
```

通过

**遗留问题**

1. `KMEMSIZE`定义为0x38000000的依据是什么；
2. 执行完`boot_map_segment`后，高线性地址如0xe8000000映射的物理地址应为0x28000000，但实际探测到的物理地址最大为0x07fdffff，测试中这类地址读为0，写入无法保存。
